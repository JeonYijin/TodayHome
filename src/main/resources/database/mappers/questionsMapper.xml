<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0 //EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.th.th1.questions.QuestionsDAO">
	
	<!-- 질문과답변 list 받아오기 -->
	<select id="getQuestionsList" parameterType="Pager" resultMap="hashtagResult_all">
		SELECT Q.*, QH.*
		FROM QUESTIONS Q left join QUESTIONS_HASHTAG QH
		ON (Q.QUESTS_NUM=QH.QUESTS_NUM)
		<if test="search != null">
			where 
				quests_nickname 
					like CONCAT('%', #{search}, '%') or 
				
				quests_contents 
					like CONCAT('%', #{search}, '%') or
					
				quests_title
					like CONCAT('%', #{search}, '%')
		</if>
		
		<if test='reply=="not_yet"'>
			where reply=0
		</if>
		
		<if test='popularity==0'>
			order by reply desc
		</if>
		
		<if test='popularity==null'>
			ORDER BY Q.QUESTS_NUM DESC
		</if>
	</select>
	
	<resultMap type="QuestionsVO" id="hashtagResult_all">
		<id column="quests_num" property="quests_num"/>
		<result column="quests_id" property="quests_id"/>
		<result column="quests_nickname" property="quests_nickname"/>
		<result column="quests_title" property="quests_title"/>
		<result column="quests_contents" property="quests_contents"/>
		<result column="list_contents" property="list_contents"/>
		<result column="hits" property="hits"/>
		<result column="regDate" property="regDate"/>
		<result column="reply" property="reply"/>
		<result column="thumbnail" property="thumbnail"/>
		<result column="notice" property="notice"/>
		<collection property="tags" javaType="List" ofType="HashtagVO">
			<id column="num" property="num"/>
			<result column="quests_num" property="quests_num"/>
			<result column="hashtag_name" property="hashtag_name"/>
		</collection>
	</resultMap>


	<!-- 질문과답변 insert -->
	<insert id="setQuestionInsert" parameterType="QuestionsVO" useGeneratedKeys="true" keyProperty="quests_num">
		INSERT INTO QUESTIONS (quests_num, quests_id, quests_nickname, quests_title, quests_contents, list_contents, hits, regDate, reply, thumbnail, notice)
		VALUES (null, #{quests_id}, #{quests_nickname}, #{quests_title}, #{quests_contents}, #{list_contents}, default, default, 0, #{thumbnail}, #{notice})
	</insert>
	
	<!-- 해시태그 가져오기 -->
	<select id="getHashtag" parameterType="QuestionsVO" resultType="HashtagVO">
		SELECT * FROM QUESTIONS_HASHTAG
		WHERE QUESTS_NUM=#{quests_num}
	</select>

	<!-- Hashtag insert -->
	<insert id="setHashtag" parameterType="com.th.th1.questions.HashtagVO">
		INSERT INTO QUESTIONS_HASHTAG
		VALUES (null, #{quests_num}, #{hashtag_name})
	</insert>
	
	<!-- 질문과답변 수정 -->
	<update id="setQuestionUpdate" parameterType="QuestionsVO">
		UPDATE QUESTIONS
		SET QUESTS_CONTENTS=#{quests_contents}, QUESTS_TITLE=#{quests_title}
		WHERE QUESTS_ID=#{quests_id} AND QUESTS_NUM=#{quests_num}
	</update>
	
	<!-- 질문과답변 삭제 -->
	<delete id="setQuestionDelete" parameterType="QuestionsVO">
		DELETE FROM QUESTIONS
		WHERE QUESTS_NUM=#{quests_num} AND QUESTS_ID=#{quests_id}
	</delete>	
	
	<!-- 댓글수 +1 update -->
	<update id="plusReplyCount" parameterType="int">
		UPDATE QUESTIONS
		SET REPLY=REPLY+1
		WHERE QUESTS_NUM=#{qnum}
	</update>
	
	<!-- 댓글수 -1 update -->
	<update id="minusReplyCount" parameterType="int">
		UPDATE QUESTIONS
		SET REPLY=REPLY-1
		WHERE QUESTS_NUM=#{qnum}
	</update>
	
	<!-- 조회수 증가 -->
	<update id="updateViewsCount" parameterType="int">
		UPDATE QUESTIONS
		SET HITS=HITS+1
		WHERE QUESTS_NUM=#{qnum}
	</update>
	
	<!-- 해시태그로 글 검색 -->
	<select id="selectFromHashtag" parameterType="java.lang.String" resultMap="selectHashtag">
		select q.*, qh.*
		from questions q inner join questions_hashtag qh
		on (q.quests_num=qh.quests_num)
		inner join hashtag h
		on (qh.hashtag_name=h.hashtag_name)
		where h.hashtag_name=#{hashtag};
	</select>
	
	<resultMap type="QuestionsVO" id="selectHashtag">
		<id column="quests_num" property="quests_num"/>
		<result column="quests_id" property="quests_id"/>
		<result column="quests_nickname" property="quests_nickname"/>
		<result column="quests_title" property="quests_title"/>
		<result column="quests_contents" property="quests_contents"/>
		<result column="list_contents" property="list_contents"/>
		<result column="hits" property="hits"/>
		<result column="regDate" property="regDate"/>
		<result column="reply" property="reply"/>
		<result column="thumbnail" property="thumbnail"/>
		<result column="notice" property="notice"/>
		<collection property="tags" javaType="List" ofType="HashtagVO">
			<id column="num" property="num"/>
			<result column="quests_num" property="quests_num"/>
			<result column="hashtag_name" property="hashtag_name"/>
		</collection>
	</resultMap>
	
	<!-- select 전체 갯수 구하기 -->
	<select id="getTotalCount" parameterType="Pager" resultType="Long">
		select count(quests_num)
		from questions
		<if test="search != null">
			where 
				quests_nickname 
					like CONCAT('%', #{search}, '%') or 
				
				quests_contents 
					like CONCAT('%', #{search}, '%') or
					
				quests_title
					like CONCAT('%', #{search}, '%')									
		</if>
	</select>
	
	<!-- 질문과답변 글하나 받아오기 -->
	<select id="getQuestionOne" parameterType="QuestionsVO" resultMap="hashtagResult">
		SELECT Q.*, QH.*
		FROM QUESTIONS Q left join QUESTIONS_HASHTAG QH
		ON (Q.QUESTS_NUM=QH.QUESTS_NUM)
		WHERE Q.QUESTS_NUM=#{quests_num}
	</select>
	
	<resultMap type="QuestionsVO" id="hashtagResult">
		<id column="quests_num" property="quests_num"/>
		<result column="quests_id" property="quests_id"/>
		<result column="quests_nickname" property="quests_nickname"/>
		<result column="quests_title" property="quests_title"/>
		<result column="quests_contents" property="quests_contents"/>
		<result column="hits" property="hits"/>
		<result column="regDate" property="regDate"/>
		<result column="reply" property="reply"/>
		<result column="notice" property="notice"/>
		<collection property="tags" javaType="List" ofType="HashtagVO">
			<id column="num" property="num"/>
			<result column="quests_num" property="quests_num"/>
			<result column="hashtag_name" property="hashtag_name"/>
		</collection>
	</resultMap>
	

</mapper>